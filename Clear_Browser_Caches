# Rename Title Window
$host.ui.RawUI.WindowTitle = "Clean Browser Temp Files"
Function Cleanup {

    Write-Host -ForegroundColor yellow "#######################################################"
    Write-Host -ForegroundColor Green "Powershell commands to delete cache & cookies in Firefox, Chrome & IE browsers `nOrigonal By Lee Bhogal, Paradise Computing Ltd - June 2014 `nhttps://github.com/lemtek/Powershell/blob/master/Clear_Browser_Caches`nVERSION: 2.7 `nEdited by Michael Bennett `n"
    Write-Host -ForegroundColor yellow "#######################################################"


    Write-Host -ForegroundColor Green "CHANGE_LOG:
v2.7: - Borrowed Chromium and Opera Cleaning from Anst-foto - https://github.com/anst-foto/Powershell
v2.6: - Fixes from Github which were not pulled from Master
        Fixed C:\users\%username% could not be found if the profiledir points to another directory - Credit Mahagon - https://github.com/Mahagon/Powershell
        Amend Clear Internet Explorer Output - Credit Watnabe - https://github.com/Watnabe/Powershell
v2.5: - Added Disk Size, Free Space, % Free. Before and After - Code Borrowed from https://gallery.technet.microsoft.com/scriptcenter/Clean-up-your-C-Drive-bc7bb3ed
		Write to Text File
		Tabbed in, cleaner to read
		Updated Alias' to Full Content
v2.4: - Resolved *.default issue, issue was with the file path name not with *.default, but issue resolved
v2.3: - Added Cache2 to Mozilla directories but found that *.default is not working
v2.2: - Added Cyan colour to verbose output
v2.1: - Added the location 'C:\Windows\Temp\*' and 'C:\`$recycle.bin\'
v2:   - Changed the retrieval of user list to dir the c:\users folder and export to csv
v1:   - Compiled script"

    Write-Host -ForegroundColor yellow "#######################################################"

    #function global:Write-Verbose {[string]$Message}

    ## check $VerbosePreference variable, and turns -Verbose on  {
    if ( $VerbosePreference -ne 'SilentlyContinue' )
    { Write-Host " $Message" -ForegroundColor 'Yellow' }


    $VerbosePreference = "Continue"
    $LogDate = get-date -format "MM-d-yy-HHmm"
    #$objShell = New-Object -ComObject Shell.Application
    #$objFolder = $objShell.Namespace(0xA)
    #$ErrorActionPreference = "silentlycontinue"

    ## Get Disk Size

    $Before = Get-WmiObject Win32_LogicalDisk | Where-Object { $_.DriveType -eq "3" } | Select-Object SystemName,
    @{ Name = "Drive" ; Expression = { ( $_.DeviceID ) } },
    @{ Name = "Size (GB)" ; Expression = {"{0:N1}" -f ( $_.Size / 1gb)}},
    @{ Name = "FreeSpace (GB)" ; Expression = {"{0:N1}" -f ( $_.Freespace / 1gb ) } },
    @{ Name = "PercentFree" ; Expression = {"{0:P1}" -f ( $_.FreeSpace / $_.Size ) } } |
        Format-Table -AutoSize | Out-String

    Start-Transcript -Path C:\Windows\Temp\$LogDate.log


    #########################
    "-------------------"
    Write-Host -ForegroundColor Green "SECTION 1: Getting the list of users"
    "-------------------"
    # Write Information to the screen
    Write-Host -ForegroundColor yellow "Exporting the list of users to c:\users\%username%\users.csv`n"
    # List the users in c:\users and export to the local profile for calling later
    Get-ChildItem C:\Users | Select-Object Name | Export-Csv -Path $env:USERPROFILE\users.csv -NoTypeInformation
    $list = Test-Path $env:USERPROFILE\users.csv
    #########################


    "-------------------"
    Write-Host -ForegroundColor Green "SECTION 2: Beginning Script..."
    "-------------------"
    if ($list) {
        "-------------------"
        #Clear Mozilla Firefox Cache
        Write-Host -ForegroundColor Green "SECTION 3: Clearing Mozilla Firefox Caches"
        "-------------------"
        Write-Host -ForegroundColor yellow "Clearing Mozilla caches"
        Write-Host -ForegroundColor cyan
        Import-CSV -Path $env:USERPROFILE\users.csv -Header Name | ForEach-Object {
            Remove-Item -path C:\Users\$($_.Name)\AppData\Local\Mozilla\Firefox\Profiles\*.default\cache\* -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path C:\Users\$($_.Name)\AppData\Local\Mozilla\Firefox\Profiles\*.default\cache\*.* -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path C:\Users\$($_.Name)\AppData\Local\Mozilla\Firefox\Profiles\*.default\cache2\entries\*.* -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path C:\Users\$($_.Name)\AppData\Local\Mozilla\Firefox\Profiles\*.default\thumbnails\* -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path C:\Users\$($_.Name)\AppData\Local\Mozilla\Firefox\Profiles\*.default\cookies.sqlite -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path C:\Users\$($_.Name)\AppData\Local\Mozilla\Firefox\Profiles\*.default\webappsstore.sqlite -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path C:\Users\$($_.Name)\AppData\Local\Mozilla\Firefox\Profiles\*.default\chromeappsstore.sqlite -Recurse -Force -EA SilentlyContinue -Verbose
        }
        Write-Host -ForegroundColor yellow "Done...`n"

        "-------------------"
        # Clear Google Chrome
        Write-Host -ForegroundColor Green "SECTION 4: Clearing Google Chrome Caches"
        "-------------------"
        Write-Host -ForegroundColor yellow "Clearing Google caches"
        Write-Host -ForegroundColor cyan
        Import-CSV -Path $env:USERPROFILE\users.csv -Header Name | ForEach-Object {
            Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Google\Chrome\User Data\Default\Cache\*" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Google\Chrome\User Data\Default\Cache2\entries\*" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Google\Chrome\User Data\Default\Cookies" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Google\Chrome\User Data\Default\Media Cache" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Google\Chrome\User Data\Default\Cookies-Journal" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Google\Chrome\User Data\Default\JumpListIconsOld" -Recurse -Force -EA SilentlyContinue -Verbose
            # Comment out the following line to remove the Chrome Write Font Cache too.
            # Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Google\Chrome\User Data\Default\ChromeDWriteFontCache" -Recurse -Force -EA SilentlyContinue -Verbose
        }

        Write-Host -ForegroundColor yellow "Done...`n"

        "-------------------"
        # Clear Internet Explorer
        Write-Host -ForegroundColor Green "SECTION 5: Clearing Internet Explorer Caches"
        "-------------------"
        Write-Host -ForegroundColor yellow "Clearing Internet Explorer caches"
        Write-Host -ForegroundColor cyan
        Import-CSV -Path $env:USERPROFILE\users.csv | ForEach-Object {
            Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Microsoft\Windows\Temporary Internet Files\*" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Microsoft\Windows\WER\*" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path "C:\Users\$($_.Name)\AppData\Local\Temp\*" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path "C:\Windows\Temp\*" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -path "C:\`$recycle.bin\" -Recurse -Force -EA SilentlyContinue -Verbose
        }

        Write-Host -ForegroundColor yellow "Done...`n"
        ""
        # Clear Opera & Chromium
        Write-Host -ForegroundColor Green "SECTION 6: Clearing Opera & Chromium Caches"
        "-------------------"
        Write-Host -ForegroundColor yellow "Clearing Opera & Chromium caches"
        Write-Host -ForegroundColor cyan
        Import-CSV -Path $env:USERPROFILE\users.csv -Header Name | ForEach-Object {
            Remove-Item -Path "C:\Users\$($_.Name)\AppData\Local\Chromium\User Data\Default\Cache\*" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -Path "C:\Users\$($_.Name)\AppData\Local\Chromium\User Data\Default\GPUCache\*" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -Path "C:\Users\$($_.Name)\AppData\Local\Chromium\User Data\Default\Media Cache" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -Path "C:\Users\$($_.Name)\AppData\Local\Chromium\User Data\Default\Pepper Data" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -Path "C:\Users\$($_.Name)\AppData\Local\Chromium\User Data\Default\Application Cache" -Recurse -Force -EA SilentlyContinue -Verbose
            Remove-Item -Path "C:\Users\$($_.Name)\AppData\Local\Opera Software\Opera Stable\Cache\*" -Recurse -Force -EA SilentlyContinue -Verbose
        }

        Write-Host -ForegroundColor yellow "Done..."
        ""
        "-------------------"

        Write-Host -ForegroundColor Green "All Tasks Done!`n`n"
    }
    else {
        Write-Host -ForegroundColor Yellow "Session Cancelled"
        Exit
    }


    ## Get Drive size after clean

    $After = Get-WmiObject Win32_LogicalDisk | Where-Object { $_.DriveType -eq "3" } | Select-Object SystemName,
    @{ Name = "Drive" ; Expression = { ( $_.DeviceID ) } },
    @{ Name = "Size (GB)" ; Expression = {"{0:N1}" -f ( $_.Size / 1gb)}},
    @{ Name = "FreeSpace (GB)" ; Expression = {"{0:N1}" -f ( $_.Freespace / 1gb ) } },
    @{ Name = "PercentFree" ; Expression = {"{0:P1}" -f ( $_.FreeSpace / $_.Size ) } } |
        Format-Table -AutoSize | Out-String

    ## Sends some before and after info for ticketing purposes

    Write-Host -ForegroundColor Green "Before: $Before"
    Write-Host -ForegroundColor Green "After: $After"

    ## Completed Successfully!
    ## Open Text File

    Invoke-Item c:\windows\temp\$LogDate.log

    ## Stop Script
    Stop-Transcript
} Cleanup
